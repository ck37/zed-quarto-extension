# Update to tree-sitter-quarto@4012bc7 - Code Block Injection Fix

**Date**: October 18, 2025
**Action**: Updated to latest grammar with fenced code block injection fix
**Issue**: Resolves https://github.com/ck37/tree-sitter-quarto/issues/7

## What Changed

### Grammar Version Update

**From**: `28111dc` (emphasis delimiters)
**To**: `4012bc7` (code block injection fix)

### The Fix

Commit `4012bc7` adds the missing `@injection.content` capture to all fenced code block patterns in `queries/injections.scm`.

**Before (broken):**
```scheme
((fenced_code_block
  info: (info_string) @_lang
  (#eq? @_lang "python"))
 (#set! injection.language "python"))
```

**After (fixed):**
```scheme
((fenced_code_block
  info: (info_string) @_lang
  (#eq? @_lang "python")
  (code_line) @injection.content)
 (#set! injection.language "python")
 (#set! injection.combined))
```

### Additional Improvements

The fix also adds `(#set! injection.combined)` which combines multiple `code_line` nodes into a single injection. This improves syntax highlighting performance and correctness.

## What Now Works

âœ… **Standard Markdown code blocks** now have syntax highlighting:

```markdown
```python
import numpy as np
print("Hello world!")
```
```

This works for **all languages**:
- Python, R, Julia
- JavaScript, TypeScript
- Bash, Shell
- SQL, JSON, YAML, TOML
- HTML, CSS
- Markdown

## Updated Files

### Extension Configuration
- `extension.toml`: rev = `4012bc7d9930654c81f1ade1d2070e0b951aa689`
- `build.rs`: QUARTO_COMMIT = `4012bc7d9930654c81f1ade1d2070e0b951aa689`

### Injection Queries
- `languages/quarto/injections.scm`: Copied from upstream with fix

## Testing Instructions

1. **Restart Zed completely** (clear grammar cache)
2. **Install dev extension**: Cmd+Shift+P â†’ "zed: install dev extension"
3. **Create test file** `test.qmd`:

```markdown
# Code Block Test

## Quarto Executable (Already Worked)
\`\`\`{python}
import numpy as np
print("Quarto style - worked before")
\`\`\`

## Standard Markdown (NOW FIXED!)
\`\`\`python
import pandas as pd
print("Standard Markdown - NOW WORKS!")
\`\`\`

## Multiple Languages

\`\`\`javascript
const x = 42;
console.log(x);
\`\`\`

\`\`\`r
x <- c(1, 2, 3)
mean(x)
\`\`\`

\`\`\`bash
echo "Hello from bash"
ls -la
\`\`\`
```

4. **Expected behavior**:
   - âœ… All code blocks should have syntax highlighting
   - âœ… Each language should be highlighted with its respective grammar
   - âœ… No difference between ` ```{python}` and ` ```python` styles

## Upstream Changes

The fix was committed to tree-sitter-quarto with full OpenSpec documentation:

- `openspec/changes/fix-fenced-code-block-injection/proposal.md`
- `openspec/changes/fix-fenced-code-block-injection/specs/language-injection/spec.md`
- `openspec/changes/fix-fenced-code-block-injection/tasks.md`

This ensures the change is well-documented and tested.

## Timeline

1. **Issue discovered**: October 18, 2025 (during Zed testing)
2. **Issue filed**: https://github.com/ck37/tree-sitter-quarto/issues/7
3. **Fix committed**: October 18, 2025 (same day!)
4. **Extension updated**: October 18, 2025 (this update)

Total time from discovery to fix: **Same day** ðŸš€

## Impact

This is a **major improvement** for Quarto users in Zed:
- No workaround needed for code blocks
- Standard Markdown syntax works as expected
- Consistent with other Markdown editors

## Related Documents

- `docs/code-injection-fix-2025-10-18.md`: Documents the fix we discovered
- `docs/update-to-28111dc-2025-10-18.md`: Previous update (emphasis delimiters)
- `docs/emphasis-delimiter-support.md`: Emphasis delimiter feature docs

## Commit Details

**Upstream commit**: https://github.com/ck37/tree-sitter-quarto/commit/4012bc7

**Full commit message:**
```
fix: add content capture to fenced code block injection queries

Adds (code_line) @injection.content capture to all fenced_code_block
injection patterns. Without this capture, code blocks had language
detection but no actual content to inject highlighting into.

Also adds (#set! injection.combined) to combine multiple code_line
nodes into a single injection for better highlighting performance.

Fixes #7
```

## Next Steps

- âœ… Update complete
- âœ… Build successful
- â³ Test in Zed (manual verification needed)
- ðŸ“ Consider updating extension version to 0.2.1 if all tests pass
