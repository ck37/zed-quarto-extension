# Zed Editor Compatibility Resolution

## Problem Summary

CI builds were failing with Zed Editor compatibility checks, specifically:
- Missing `TSMapSlice` type in parser.h
- Missing `abi_version` field in TSLanguage struct
- WASM build failures with "Failed to locate a tree-sitter.json file"

## Initial Misunderstanding

Originally, we believed the issue was a simple type mismatch between parser.c and parser.h:
- parser.c using old `TSFieldMapSlice`
- parser.h using new `TSMapSlice`

We attempted manual fixes (adding typedefs, using sed to change field names), but these broke the parser completely, causing all tests to fail with citation_key errors.

## Root Cause

The actual problem was **tree-sitter CLI version mismatch**:

### tree-sitter CLI 0.23.x generates:
- `TSFieldMapSlice` type (old)
- `.version` field (old)
- `TSLexMode` type (old)
- No requirement for tree-sitter.json

### tree-sitter CLI 0.25.10 generates:
- `TSMapSlice` type (new)
- `.abi_version` field (new)
- `TSLexMode` with void* cast (new)
- **Requires tree-sitter.json configuration file**

### Zed Editor requirements:
- tree-sitter 0.25.10 headers (TSMapSlice, abi_version, TSLexerMode)
- WASM build support
- Proper tree-sitter.json configuration

## Solution

### 1. Upgrade tree-sitter CLI (package.json)

```json
"devDependencies": {
  "prebuildify": "^6.0.0",
  "tree-sitter-cli": "^0.25.10"  // was: ^0.23.2
}
```

### 2. Create tree-sitter.json

The CLI 0.25.10 requires a tree-sitter.json configuration file at the project root:

```json
{
  "grammars": [
    {
      "name": "quarto",
      "camelcase": "Quarto",
      "scope": "source.quarto",
      "file-types": ["qmd"],
      "path": ".",
      "highlights": "queries/highlights.scm",
      "injections": "queries/injections.scm",
      "locals": "queries/locals.scm"
    }
  ],
  "metadata": {
    "version": "0.0.1",
    "license": "MIT",
    "description": "Tree-sitter parser for Quarto Markdown (.qmd files)",
    "authors": [
      {
        "name": "Chris Kennedy"
      }
    ],
    "links": {
      "repository": "https://github.com/ck37/tree-sitter-quarto"
    }
  },
  "bindings": {
    "node": true
  }
}
```

**Key points about tree-sitter.json structure:**
- `metadata` must be at root level, NOT inside the grammars array
- `highlights`, `injections`, `locals` should be strings, not arrays
- Must include `version` field in metadata (required)

### 3. Regenerate parser

```bash
npm install                    # Install CLI 0.25.10
npx tree-sitter generate       # Regenerate parser.c with correct types
npx tree-sitter test           # Verify all tests pass
```

### 4. Verify tree-sitter headers

The src/tree_sitter/ directory should contain headers from tree-sitter 0.25.10:
- parser.h (with TSMapSlice, abi_version, TSLexerMode)
- alloc.h (memory allocation utilities)
- array.h (array utilities)

These are automatically generated by `tree-sitter generate` and should be committed to version control.

## Commits

The fix was implemented in these commits:

1. **375bc85** - "feat: upgrade to tree-sitter CLI 0.25.10 and regenerate parser"
   - Upgraded package.json dependency
   - Regenerated parser.c with correct types
   - Updated tree-sitter headers

2. **ea47f69** - "feat: add tree-sitter.json for CLI 0.25.10 WASM build"
   - Created initial tree-sitter.json (with incorrect metadata placement)

3. **b1b4cbd** - "fix: move metadata to root level in tree-sitter.json"
   - Fixed tree-sitter.json structure
   - Moved metadata to root level
   - Changed query file references from arrays to strings

## Key Takeaways

1. **Don't manually edit generated parser.c** - It has complex internal dependencies that break if you modify types post-generation

2. **CLI version matters** - The tree-sitter CLI version must match the header files you're using

3. **tree-sitter.json is required for CLI 0.25+** - Without it, WASM builds will fail

4. **Metadata placement matters** - In tree-sitter.json, `metadata` goes at root level, not inside grammars array

5. **Upgrade, don't patch** - When facing type mismatches, upgrade the CLI and regenerate rather than trying to patch generated code

## Testing

After implementing the fix:

### Local tests:
```bash
npx tree-sitter test
# Result: 58/58 tests passing (100%)
```

### CI results:
All jobs passing, including:
- ✓ Validate Grammar
- ✓ Validate Queries
- ✓ Test Parser (all platforms/Node versions)
- ✓ Lint Code
- ✓ **Zed Editor Compatibility** (the critical check)

## Future Maintenance

When updating tree-sitter versions in the future:

1. Update `tree-sitter-cli` version in package.json
2. Run `npm install`
3. Run `npx tree-sitter generate` to regenerate parser
4. Verify tree-sitter.json structure matches CLI requirements
5. Run `npx tree-sitter test` to ensure tests pass
6. Commit both parser.c and src/tree_sitter/*.h together

Do NOT attempt to manually sync types between CLI versions - always regenerate with the correct CLI version.

## References

- tree-sitter CLI 0.25.10 release notes
- tree-sitter.json format: https://tree-sitter.github.io/tree-sitter/cli/init.html
- Example tree-sitter.json: https://github.com/tree-sitter/tree-sitter-json/blob/master/tree-sitter.json
- Zed editor tree-sitter integration requirements
